<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K D Memorial - Admin Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  
  <div id="nprogress"><div class="bar" id="progressBar"></div></div>

  <div id="appLoader">
    <div class="spinner"></div>
    <div class="loader-text">Loading ERP System</div>
    <div class="loader-sub">Syncing Financial Data...</div>
  </div>

  <div class="layout-container">
    
    <!-- Mobile Menu Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo-area">
        <div class="logo-icon"><span class="material-icons-round">school</span></div>
        <div class="logo-text">K D Memorial<br><span style="opacity:0.6; font-weight:400; font-size:0.8rem">Admin Portal</span></div>
      </div>
      
      <nav class="nav-menu">
        <div class="nav-label">MAIN</div>
        <button class="nav-item active" onclick="switchView('dashboard', this)">
          <span class="material-icons-round">grid_view</span> Dashboard
        </button>
        <button class="nav-item" onclick="switchView('database', this)">
          <span class="material-icons-round">people</span> All Students
        </button>
        
        <div class="nav-label">TRANSPORT</div>
        <button class="nav-item" onclick="switchView('van', this)">
          <span class="material-icons-round">directions_bus</span> Van Students
        </button>
        
        <div class="nav-label">FINANCE</div>
        <button class="nav-item" onclick="switchView('daybook', this); loadDayBook();">
          <span class="material-icons-round">book</span> Day Book
        </button>
        <button class="nav-item" onclick="switchView('expenses', this); loadExpenses();">
          <span class="material-icons-round">receipt</span> Expenses
        </button>
        <button class="nav-item" onclick="switchView('staff', this); loadStaff();">
           <span class="material-icons-round">badge</span> Staff Payroll
        </button>

        <div class="nav-label">SYSTEM</div>
        <button class="nav-item" onclick="switchView('reports', this)">
           <span class="material-icons-round">print</span> Print/Reports
        </button>
      </nav>

      <div class="user-profile">
        <div class="user-avatar">A</div>
        <div class="user-info">
          <h4 style="color:white; margin:0; font-size:0.9rem;">Admin User</h4>
          <p style="color:#64748b; margin:0; font-size:0.75rem;">Online</p>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <header class="top-header">
         <button class="hamburger" onclick="toggleMobileMenu()">
           <span class="material-icons-round">menu</span>
         </button>
         <div class="header-titles">
           <h2 id="pageTitle">Dashboard</h2>
         </div>
         
         <div class="header-actions" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <div class="search-bar">
              <span class="material-icons-round" style="color:#94a3b8">search</span>
              <input type="text" id="searchInput" placeholder="Search...">
            </div>
            <button onclick="sendBulkWA()" class="btn-whatsapp" title="Send Bulk WhatsApp">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.029.66 2.028.938 3.267.938 3.188 0 5.768-2.587 5.768-5.771.001-3.185-2.58-5.767-5.769-5.767zm0 10.198c-1.125 0-2.062-.271-2.923-.746l-1.399.367.373-1.359c-.538-.857-.822-1.637-.821-2.693.001-2.441 1.987-4.428 4.428-4.428 2.443 0 4.43 1.986 4.43 4.427 0 2.442-1.985 4.43 4.432z"/></svg>
            </button>
            <button onclick="openModal('NEW')" class="btn-primary">
              <span class="material-icons-round">add</span> <span class="btn-text">Add</span>
            </button>
         </div>
      </header>

      <!-- Dashboard View -->
      <div id="view-dashboard" class="view-section active">
        <div class="bento-grid">
           <div class="card kpi-card blue">
             <div class="kpi-icon"><span class="material-icons-round">account_balance_wallet</span></div>
             <div>
               <p style="margin:0; color:#64748b; font-size:0.9rem">Total Collected</p>
               <h1 id="kpiCollected">₹0</h1>
             </div>
           </div>

           <div class="card kpi-card orange">
              <div class="kpi-icon"><span class="material-icons-round">pending_actions</span></div>
              <div>
                <p style="margin:0; color:#64748b; font-size:0.9rem">Pending Dues</p>
                <h1 id="kpiPending">₹0</h1>
              </div>
           </div>

           <div class="card kpi-card green">
              <div class="kpi-icon"><span class="material-icons-round">groups</span></div>
              <div>
                <p style="margin:0; color:#64748b; font-size:0.9rem">Total Students</p>
                <h1 id="kpiCount">0</h1>
              </div>
           </div>
        </div>
      </div>

      <!-- Database View -->
      <div id="view-database" class="view-section">
         <div class="filter-row">
           <div class="chip-group" id="classChips"></div>
         </div>
         <div class="table-container">
           <table class="data-table">
             <thead>
               <tr>
                 <th onclick="sortData('roll')" width="10%">Roll <span id="sort-roll" class="material-icons-round sort-icon">sort</span></th>
                 <th onclick="sortData('name')" width="25%">Student <span id="sort-name" class="material-icons-round sort-icon">sort</span></th>
                 <th onclick="sortData('classVal')" width="10%">Class <span id="sort-classVal" class="material-icons-round sort-icon">sort</span></th>
                 <th width="25%">Fees Structure</th>
                 <th onclick="sortData('balance')" width="15%">Balance <span id="sort-balance" class="material-icons-round sort-icon">sort</span></th>
                 <th width="15%">Actions</th>
               </tr>
             </thead>
             <tbody id="tableBody"></tbody>
           </table>
         </div>
      </div>

      <!-- Van View -->
      <div id="view-van" class="view-section">
          <div class="bento-grid" style="margin-bottom:24px; grid-template-columns: 1fr 1fr;">
              <div class="card kpi-card" style="padding:20px;">
                  <div class="kpi-icon" style="background:#f1f5f9;"><span class="material-icons-round">directions_bus</span></div>
                  <div><p style="margin:0; color:#64748b">Van Students</p><h2 style="margin:0" id="vanCount">0</h2></div>
              </div>
              <div class="card kpi-card" style="padding:20px;">
                  <div class="kpi-icon" style="background:#f1f5f9;"><span class="material-icons-round">payments</span></div>
                  <div><p style="margin:0; color:#64748b">Est. Monthly Revenue</p><h2 style="margin:0" id="vanRevenue">₹0</h2></div>
              </div>
          </div>
          <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th onclick="sortData('roll')" width="10%">Roll <span class="material-icons-round sort-icon">sort</span></th>
                    <th onclick="sortData('name')" width="30%">Student <span class="material-icons-round sort-icon">sort</span></th>
                    <th width="15%">Class</th>
                    <th onclick="sortData('van')" width="15%">Van Fee <span class="material-icons-round sort-icon">sort</span></th>
                    <th onclick="sortData('balance')" width="15%">Total Due <span class="material-icons-round sort-icon">sort</span></th>
                    <th width="15%">Actions</th>
                  </tr>
                </thead>
                <tbody id="vanTableBody"></tbody>
              </table>
            </div>
      </div>
      
      <!-- Reports View -->
      <div id="view-reports" class="view-section">
         <div class="card" style="max-width:500px; margin:40px auto; text-align:center; padding:40px;">
           <div style="background:#f1f5f9; width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
              <span class="material-icons-round" style="font-size:40px; color:#64748b;">print</span>
           </div>
           <h3>Printing Instructions</h3>
           <p style="color:#64748b; line-height:1.6; margin-top:10px;">To print a receipt, go to the <strong>"All Students"</strong> or <strong>"Van Students"</strong> tab, click on a student's name to open their profile, and select "Print".</p>
         </div>
      </div>

      <!-- Day Book View -->
      <div id="view-daybook" class="view-section">
        <div class="bento-grid" style="margin-bottom:20px;">
           <div class="card kpi-card green">
              <div><p>Today's In (Fees)</p><h2 id="day_in">₹0</h2></div>
           </div>
           <div class="card kpi-card orange">
              <div><p>Today's Out (Exp)</p><h2 id="day_out">₹0</h2></div>
           </div>
           <div class="card kpi-card blue">
              <div><p>Net Cash in Hand</p><h2 id="day_net">₹0</h2></div>
           </div>
        </div>
        
        <div class="card">
           <h3>Today's Transactions</h3>
           <table class="data-table">
             <thead><tr><th>Time</th><th>Details</th><th>Mode</th><th>Amount</th></tr></thead>
             <tbody id="daybook_body"></tbody>
           </table>
        </div>
      </div>

      <!-- Expenses View -->
      <div id="view-expenses" class="view-section">
          <div class="header-actions" style="margin-bottom:20px;">
             <h2>Expense Manager</h2>
             <button class="btn-primary" onclick="document.getElementById('expModal').style.display='flex'">Add Expense</button>
          </div>
          
          <div class="table-container">
            <table class="data-table">
              <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th></tr></thead>
              <tbody id="exp_body"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

      <!-- Staff View -->
      <div id="view-staff" class="view-section">
          <div class="header-actions" style="margin-bottom:20px;">
            <h2>Staff Management</h2>
            <button class="btn-primary" onclick="openStaffModal('NEW')">Add Staff</button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead><tr><th>Name</th><th>Role</th><th>Salary</th><th>Advance Taken</th><th>Action</th></tr></thead>
              <tbody id="staff_body"></tbody>
            </table>
          </div>
      </div>

    </main>
  </div>

  <!-- Student Modal -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Student Details</h2>
        <button onclick="closeModal()" class="close-btn"><span class="material-icons-round">close</span></button>
      </div>
      <form id="studentForm" onsubmit="handleFormSubmit(event)">
        <input type="hidden" id="studentId">
        <div class="form-grid">
           <div class="input-group"><label>Roll No</label><input type="number" id="inpRoll" required></div>
           <div class="input-group"><label>Class</label><input type="text" id="inpClass" required></div>
           <div class="input-group full"><label>Student Name</label><input type="text" id="inpName" required></div>
           <div class="input-group full"><label>Father Name</label><input type="text" id="inpFather"></div>
           <div class="input-group full"><label>Mobile No</label><input type="number" id="inpPhone" placeholder="9876543210"></div>
            <div class="input-group"><label>Email</label><input type="email" id="inpEmail" placeholder="email@example.com"></div>
            <div class="input-group"><label>Date of Birth</label><input type="date" id="inpDOB"></div>
            <div class="input-group full"><label>Address</label><input type="text" id="inpAddress" placeholder="Full address"></div>
            <div class="input-group"><label>Van Route</label><input type="text" id="inpRoute" placeholder="Route-1"></div>
            <div class="input-group"><label>Pickup Point</label><input type="text" id="inpPickup" placeholder="Main Gate"></div>
           
           <div class="divider full" style="margin-top:10px; border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px; color:#94a3b8; font-size:0.75rem; font-weight:700;">FEE STRUCTURE</div>
           <div class="input-group"><label>Tuition Fee</label><input type="number" id="inpTuition" value="0"></div>
           <div class="input-group"><label>Van Fee</label><input type="number" id="inpVan" value="0"></div>
           <div class="input-group"><label>Other/Exam</label><input type="number" id="inpOther" value="0"></div>
           <div class="input-group"><label>Prev Balance</label><input type="number" id="inpPrev" value="0"></div>
           <div class="input-group full"><label>Received (Legacy)</label><input type="number" id="inpRec" value="0" readonly style="background:#f1f5f9;"></div>
        </div>
        <div class="modal-footer">
           <button type="button" onclick="deleteRecord()" class="btn-danger">Delete</button>
           <button type="submit" id="btnSave" class="btn-primary">Save Record</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Fee Modal -->
  <div id="feeModalOverlay" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2>Collect Fee</h2>
          <button onclick="document.getElementById('feeModalOverlay').style.display='none'" class="close-btn">&times;</button>
        </div>
        <div class="form-grid">
          <div class="full" style="background:#f0f9ff; padding:10px; border-radius:8px;">
            <strong>Student:</strong> <span id="fee_name"></span> (Class <span id="fee_class"></span>)<br>
            <strong>Current Balance:</strong> <span id="fee_bal" style="color:#ef4444; font-weight:bold;"></span>
          </div>
          
          <div class="input-group full">
            <label>Amount Received (₹)</label>
            <input type="number" id="fee_amount" placeholder="Enter Amount" style="font-size:1.2rem; font-weight:bold;">
          </div>
          
          <div class="input-group">
            <label>Payment Mode</label>
            <select id="fee_mode" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
              <option value="Cash">Cash</option>
              <option value="UPI">UPI / GPay</option>
              <option value="Bank Transfer">Bank Transfer</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>Remarks</label>
            <input type="text" id="fee_remarks" placeholder="Optional">
          </div>
        </div>
        <div class="modal-footer">
           <button class="btn-primary" onclick="submitFee()" style="width:100%">Confirm Payment</button>
        </div>
      </div>
    </div>

  <!-- Expense Modal -->
  <div id="expModal" class="modal-overlay">
      <div class="modal" style="height:auto;">
        <div class="modal-header"><h2 id="expModalTitle">New Expense</h2><button onclick="document.getElementById('expModal').style.display='none'" class="close-btn">&times;</button></div>
        <div class="form-grid">
           <input type="hidden" id="expId">
           <div class="input-group"><label>Category</label>
             <select id="exp_cat" style="width:100%; padding:10px;"><option>Transport</option><option>Office</option><option>Maintenance</option><option>Salary</option><option>Other</option></select>
           </div>
           <div class="input-group"><label>Amount</label><input type="number" id="exp_amt"></div>
           <div class="input-group full"><label>Description</label><input type="text" id="exp_desc"></div>
        </div>
        <div class="modal-footer">
           <button type="button" id="expDeleteBtn" onclick="deleteExpense()" class="btn-danger" style="display:none;">Delete</button>
           <button class="btn-primary" onclick="submitExp()">Save Expense</button>
        </div>
      </div>
    </div>

  <!-- Staff Modal -->
  <div id="staffModal" class="modal-overlay">
      <div class="modal" style="height:auto;">
        <div class="modal-header"><h2 id="staffModalTitle">Add Staff</h2><button onclick="document.getElementById('staffModal').style.display='none'" class="close-btn">&times;</button></div>
        <div class="form-grid">
           <input type="hidden" id="staffId">
           <div class="input-group full"><label>Name</label><input type="text" id="staff_name"></div>
           <div class="input-group"><label>Role</label><input type="text" id="staff_role"></div>
           <div class="input-group"><label>Salary</label><input type="number" id="staff_salary"></div>
        </div>
        <div class="modal-footer">
           <button type="button" id="staffDeleteBtn" onclick="deleteStaff()" class="btn-danger" style="display:none;">Delete</button>
           <button class="btn-primary" onclick="submitStaff()">Save Staff</button>
        </div>
      </div>
    </div>

  <!-- Profile Overlay -->
  <div id="profileOverlay" class="modal-overlay">
    <div class="modal profile-modal">
       <div class="profile-header">
          <div class="avatar-lg" id="avatarLetter">A</div>
          <h2 id="pName" style="margin:0; font-size:1.25rem;">Student Name</h2>
          <p style="color:#64748b; margin:4px 0 0;">Class <span id="pClass"></span> &bull; Roll #<span id="pRoll"></span></p>
       </div>
       <div class="form-grid" style="padding:20px; border-bottom:1px solid #f1f5f9;">
          <div style="grid-column:span 2; display:flex; justify-content:space-between;">
              <span style="color:#64748b">Father Name</span>
              <span class="val" id="pFather"></span>
          </div>
          <div style="grid-column:span 2; display:flex; justify-content:space-between;">
              <span style="color:#64748b">Mobile</span>
              <span class="val" id="pPhone"></span>
          </div>
          <div style="grid-column:span 2; display:flex; justify-content:space-between; margin-top:5px; padding-top:5px; border-top:1px dashed #e2e8f0;">
              <span style="color:#64748b; font-size:0.85rem">Last Reminder</span>
              <span class="val" id="pLastRem" style="font-size:0.85rem; color:#4f46e5;">Never</span>
          </div>
       </div>
       <div style="background:#f8fafc; padding:20px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <span style="color:#64748b; font-size:0.9rem">Total Fees</span>
              <span style="font-weight:600" id="pTotal"></span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
              <span style="color:#64748b; font-size:0.9rem">Paid Amount</span>
              <span style="font-weight:600; color:#10b981" id="pPaid"></span>
          </div>
          <div style="display:flex; justify-content:space-between; border-top:1px dashed #cbd5e1; padding-top:8px;">
              <span style="color:#1e293b; font-weight:700;">Pending Due</span>
              <span style="font-weight:700; color:#ef4444; font-size:1.1rem" id="pBal"></span>
          </div>
       </div>
       <div class="profile-actions">
          <button onclick="openFeeModal()" class="btn-primary" style="grid-column: span 2; justify-content:center;">
              <span class="material-icons-round" style="font-size:18px;">payments</span> Collect Fee
          </button>
          
          <button onclick="sendWA()" class="btn-wa">
              <span style="font-size:18px; fill:currentColor;"><svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.029.66 2.028.938 3.267.938 3.188 0 5.768-2.587 5.768-5.771.001-3.185-2.58-5.767-5.769-5.767zm0 10.198c-1.125 0-2.062-.271-2.923-.746l-1.399.367.373-1.359c-.538-.857-.822-1.637-.821-2.693.001-2.441 1.987-4.428 4.428-4.428 2.443 0 4.43 1.986 4.43 4.427 0 2.442-1.985 4.43 4.432z"/></svg></span> 
              WhatsApp
          </button>
          <button onclick="printCurrent()" class="btn-sec">Print</button>
          <button onclick="closeProfile()" class="btn-sec">Close</button>
       </div>
    </div>
  </div>

  <!-- Print Area -->
  <div id="printArea" style="display:none;"></div>

  <!-- Bulk WhatsApp Selection Modal -->
  <div id="bulkWAModal" class="modal-overlay">
    <div class="modal" style="max-height:80vh;">
      <div class="modal-header">
        <h2>Send Bulk WhatsApp</h2>
        <button onclick="closeBulkWA()" class="close-btn"><span class="material-icons-round">close</span></button>
      </div>
      <div style="padding:16px; border-bottom:1px solid var(--border);">
        <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
          <button class="btn-primary" onclick="selectAllWA()" style="font-size:0.8rem;">Select All</button>
          <button class="btn-sec" onclick="deselectAllWA()" style="font-size:0.8rem;">Deselect All</button>
          <button class="btn-primary" style="background:#10b981; font-size:0.8rem;" onclick="sendSelectedWA()">
            <span class="material-icons-round" style="font-size:16px;">send</span> Send (<span id="waSelectedCount">0</span>)
          </button>
        </div>
        <input type="text" id="waSearch" placeholder="Search students..." onkeyup="filterWASelection()" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:8px;">
      </div>
      <div id="waSelectionList" style="flex:1; overflow-y:auto; padding:10px; max-height:400px;">
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
